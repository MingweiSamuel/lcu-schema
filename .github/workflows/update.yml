name: Update LCU Workflow
on:
  push:
  workflow_dispatch:
  schedule:
  - cron: '18 0 * * *'

jobs:
  build:
    name: Update LCU Job
    runs-on: windows-2019
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Install League of Legends
        run: choco install -y leagueoflegends

      - name: Run LCU To Update
        run: |
          & 'C:\Riot Games\League of Legends\LeagueClient.exe'
          Start-Sleep 180

      - name: Write LoL Login
        env:
          LOLLOGIN: ${{ secrets.lollogin }}
        run: $env:LOLLOGIN | Out-File -Encoding UTF8 'lollogin.json'

      - name: Clone gh-pages output folder
        shell: bash
        run: git clone --single-branch -b gh-pages "$(git remote get-url origin)" out

      - name: Run update.ps1
        run: .\update.ps1
        shell: powershell # Use powershell 5 (not 7)

      - name: Commit Changes
        shell: bash
        run: |
          cd out
          git config user.name 'Github Actions'
          git config user.email "$(git show -s --format='%ae' HEAD)"
          changes=$(git diff -U0 | grep '^[+-][^+-]' |
            grep -v 'Http' | grep -v 'LOCKED"' | wc -l)
          if [ $changes -gt 0 ]; then
            git commit -am "Update $(date -u -Is), script $(git log --pretty=format:%h -n 1)"
            git push
          fi
